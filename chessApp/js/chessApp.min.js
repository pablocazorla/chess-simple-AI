$("document").ready(function(){"use strict";var t,n=3,i="black",s="white",o="",a="",r="a",l="wikipedia",c={P:"-",T:"-",PPS:"-"},f=new Chess,u=!1,m=function(){var e={DEPTH:n,AI_COLOR:i,PGN:o,MESSAGE:a,THEME:r,PIECES:l,STATS:c};localStorage.setItem("reinablanca",JSON.stringify(e))},h=function(){localStorage.removeItem("reinablanca")};(function(){var e=localStorage.getItem("reinablanca");if(e){var t=JSON.parse(e);n=t.DEPTH,i=t.AI_COLOR,s="white"===t.AI_COLOR?"black":"white",o=t.PGN,a=t.MESSAGE,r=t.THEME,l=t.PIECES,c=t.STATS}})();var e,p,d=function(){for(var a,r,l,c,f,u=function(){},e={get:function(e){u=e}},t=new Chess,m=0,h=0,p=[],n=function(e){if(h+=e.data.positionCount,p.push(e.data.bestMove),--f<=0){r=(new Date).getTime(),l=(r-a)/1e3,c=Math.round(h/l);var t=-999999999999999,n=null;if(0<m)p.forEach(function(e){e.val>t&&(t=e.val,n=e.mov)});else{var s=(i=3,null==(o=0)&&null==i?0:(null==i&&(i=o,o=0),o+Math.floor(Math.random()*(i-o+1))));n=p[s].mov}u({positionCount:h,moveTime:l,positionsPerS:c,bestMove:n}),m++}var o,i},i=[],s=0;s<4;s++){var o=new Worker("js/ai_evaluator.min.js");o.onmessage=n,i.push(o)}return e.post=function(s){if(s.newGame)m=0;else{t.load(s.fen);var e=t.moves();e.sort(function(e,t){return.5-Math.random()});var o=function(e,t){var n=0,s=e.length,o=[];for(n=0;n<s;n+=t){var i=e.slice(n,n+t);o.push(i)}return o}(e,Math.ceil(e.length/4));h=0,p=[],a=(new Date).getTime(),f=4,i.forEach(function(e,t){var n=o[t]||[];e.postMessage({aiColor:"white"===s.aiColor?"w":"b",depth:s.depth,fen:s.fen,possibleMoves:n})})}},e}(),v={};v.Presentation=(e=!0,(p={elem:$("#presentation"),animElems:$("#presentation .an-top"),toggle:function(){e?(e=!1,this.elem.removeClass("shown"),setTimeout(function(){p.animElems.removeClass("ready")},600)):(e=!0,this.elem.addClass("shown"),setTimeout(function(){p.animElems.addClass("ready")},500))}}).elem.click(function(){p.toggle()}),setTimeout(function(){p.animElems.addClass("ready")},50),p);var g,C,b,k,w,S,I,M,P,E,T,O,_,y=!1;v.Menu=(g=!1,C={elem:$("#menu"),animElems:$("#menu .an-left"),toggle:function(){g?(g=!1,this.elem.removeClass("shown"),C.animElems.removeClass("ready"),setTimeout(function(){y&&(y=!1,q())},800)):u||(g=!0,this.elem.addClass("shown"),setTimeout(function(){C.animElems.addClass("ready")},300))}}),$(".toggle-menu").click(function(){v.Menu.toggle()}),$(".toggle-presentation").click(function(){v.Presentation.toggle()}),v.Options={},v.Options.Theme=(b=$("#board-container"),(k={elems:$("#opt-theme .th-box"),set:function(e){this.elems.removeClass("current").filter(".th-box-"+e).addClass("current"),r=e,b.removeClass("theme-a").removeClass("theme-b").addClass("theme-"+r),m()}}).elems.filter(".th-box-a").click(function(){k.set("a")}),k.elems.filter(".th-box-b").click(function(){k.set("b")}),k),v.Options.Pieces=((w={elems:$("#opt-pieces .btn-op-col"),set:function(e){this.elems.removeClass("current").filter(".b-"+e).addClass("current"),e!==l&&(l=e,m(),L())}}).elems.filter(".b-wikipedia").click(function(){w.set("wikipedia")}),w.elems.filter(".b-freepik").click(function(){w.set("freepik")}),w),v.Options.Color=((S={elems:$("#opt-color .btn-op-col"),set:function(e){this.elems.removeClass("current").filter("."+e).addClass("current"),i="white"===(s=e)?"black":"white",t&&t.orientation(s),m()}}).elems.filter(".white").click(function(){S.set("white"),y=!0}),S.elems.filter(".black").click(function(){S.set("black"),y=!0}),S),v.Options.Depth=((I={elems:$("#opt-depth .btn-op-depth"),set:function(e){this.elems.removeClass("current").filter(".v"+e).addClass("current"),n=e,m()}}).elems.click(function(){var e=parseInt($(this).text(),10);I.set(e)}),I),v.Info={},v.Info.Messages={elems:$("#msg .mesg"),container:$("#board-container"),set:function(e){a=e,this.elems.hide(),this.container.removeClass("think"),e&&(a=e,this.elems.filter(".msg-"+e).show(),"think"===e&&this.container.addClass("think")),m()}},v.Info.Stats=(M=$("#position-count"),P=$("#time"),E=$("#positions-per-s"),{set:function(e){M.text(e.positionCount),P.text(e.time),E.text(e.positionsPerS),c.P=e.positionCount,c.T=e.time,c.PPS=e.positionsPerS}}),v.Info.Historial=(T=$("#move-history"),{set:function(e){var t="";if(e)for(var n=0;n<e.length;n++)t+=e[n],n<e.length-1&&(t+=", ");T.text(t).scrollTop(T[0].scrollHeight),o=f.pgn(),m()}}),v.newGame=(O={set:function(){x(),y="black"===s}},$("#btn-new-game").click(function(){O.set()}),O),v.undo=(_={set:function(){D()}},$("#btn-undo").click(function(){_.set()}),_),v.Options.Theme.set(r),v.Options.Pieces.set(l),v.Options.Color.set(s),v.Options.Depth.set(n);var H={draggable:!0},x=function(){u||(v.Info.Messages.set(null),v.Info.Historial.set(null),v.Info.Stats.set({positionCount:"-",time:"-",positionsPerS:"-"}),t.clear(),t.orientation(s),t.position("start"),f.reset(),m(),d.post({newGame:!0}))},D=function(){u||f.game_over()||(f.undo(),f.undo(),t.position(f.fen()),v.Info.Historial.set(f.history()))},q=function(){if(f.game_over())return f.in_draw()||f.insufficient_material()?v.Info.Messages.set("draw"):v.Info.Messages.set("checkmate-"+s),h(),!1;u=!0,v.Info.Messages.set("think"),d.post({aiColor:i,depth:n,fen:f.fen()})};d.get(function(e){if(u=!1,v.Info.Stats.set({positionCount:e.positionCount,time:Math.round(10*e.moveTime)/10+"s",positionsPerS:e.positionsPerS}),f.move(e.bestMove),t.position(f.fen()),v.Info.Historial.set(f.history()),f.game_over())return f.in_draw()||f.insufficient_material()?v.Info.Messages.set("draw"):v.Info.Messages.set("checkmate-"+i),h(),!1;!0===f.in_check()?v.Info.Messages.set("check"):v.Info.Messages.set(null)});var A=function(e){$("#board .square-"+e).addClass("current")},G=function(e){$("#board .square-"+e).addClass("possible")},N=function(){$("#board .square-55d63").removeClass("possible").removeClass("current")};H.onMouseoverSquare=function(e,t){if(!u){var n=f.moves({square:e,verbose:!0});if(0===n.length)return;A(e);for(var s=0;s<n.length;s++)G(n[s].to)}},H.onMouseoutSquare=N,H.onSnapEnd=function(){t.position(f.fen())},H.onDragStart=function(e,t,n,s){var o="white"===i?/^w/:/^b/;if(!0===f.in_checkmate()||!0===f.in_draw()||-1!==t.search(o)||u)return!1},H.onDrop=function(e,t){if(!u){var n=f.move({from:e,to:t,promotion:"q"});if(N(),null===n)return"snapback";!0===f.in_check()?v.Info.Messages.set("check"):v.Info.Messages.set(null),v.Info.Historial.set(f.history()),q()}};var L=function(){t&&t.destroy(),H.pieceTheme="img/chesspieces/"+l+"/{piece}.png",(t=ChessBoard("board",H)).position(f.fen())};L(),""!==o?(f.load_pgn(o),t.position(f.fen()),t.orientation(s),v.Info.Historial.set(f.history()),v.Info.Messages.set(a),v.Info.Stats.set({positionCount:c.P,time:c.T,positionsPerS:c.PPS})):x()});