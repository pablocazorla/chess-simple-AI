importScripts("libs/chess.min.js");var positionCount,game=new Chess,evaluateBoard=function(o,n){var r={p:100,n:350,b:350,r:525,q:1015,k:1e4},s={pw:[[9,9,9,9,9,9,9,9],[5,5,5,5,5,5,5,5],[1,1,2,4,4,2,1,1],[.5,.5,1,3.5,3.5,1,.5,.5],[0,0,0,3,3,0,0,0],[.5,-.5,-1,0,0,-1,-.5,.5],[.5,1,1,-3,-3,1,1,.5],[0,0,0,0,0,0,0,0]],nw:[[-5,-4,-3,-3,-3,-3,-4,-5],[-4,-2,0,0,0,0,-2,-4],[-3,0,1,1.5,1.5,1,0,-3],[-3,.5,1.5,2,2,1.5,.5,-3],[-3,0,1.5,2,2,1.5,0,-3],[-3,.5,1,1.5,1.5,1,.5,-3],[-4,-2,0,.5,.5,0,-2,-4],[-5,-4,-3,-3,-3,-3,-4,-5]],bw:[[-2,-1,-1,-1,-1,-1,-1,-2],[-1,0,0,0,0,0,0,-1],[-1,0,.5,1,1,.5,0,-1],[-1,.5,.5,1,1,.5,.5,-1],[-1,0,1,1,1,1,0,-1],[-1,1,1,1,1,1,1,-1],[-1,.5,0,0,0,0,.5,-1],[-2,-1,-1,-1,-1,-1,-1,-2]],rw:[[0,0,0,0,0,0,0,0],[.5,1,1,1,1,1,1,.5],[-.5,0,0,0,0,0,0,-.5],[-.5,0,0,0,0,0,0,-.5],[-.5,0,0,0,0,0,0,-.5],[-.5,0,0,0,0,0,0,-.5],[-.5,0,0,0,0,0,0,-.5],[0,0,0,.5,.5,0,0,0]],qw:[[-2,-1,-1,-.5,-.5,-1,-1,-2],[-1,0,0,0,0,0,0,-1],[-1,0,.5,.5,.5,.5,0,-1],[-.5,0,.5,.5,.5,.5,0,-.5],[0,0,.5,.5,.5,.5,0,-.5],[-1,.5,.5,.5,.5,.5,0,-1],[-1,0,.5,0,0,0,0,-1],[-2,-1,-1,-.5,-.5,-1,-1,-2]],kw:[[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-3,-4,-4,-5,-5,-4,-4,-3],[-2,-3,-3,-4,-4,-3,-3,-2],[-1,-2,-2,-2,-2,-2,-2,-1],[2,2,0,0,0,0,2,2],[2,4,1,0,0,1,4,2]]},a=function(o){return o.slice().reverse()};s.pb=a(s.pw),s.nb=a(s.nw),s.bb=a(s.bw),s.rb=a(s.rw),s.qb=a(s.qw),s.kb=a(s.kw);var i=0;return o.forEach(function(o,t){o.forEach(function(o,a){if(o){var e=10*s[o.type+o.color][t][a];i+=(r[o.type]+e)*(o.color===n?1:-1)}})}),i},calcBestMove=function(o,a,e,t,n,r,s){var i;positionCount++;var v=null;if(0===o)return[i=evaluateBoard(a.board(),e),v=a.moves()[0]];var u=s&&0<s.length?s:a.moves();u.sort(function(o,a){return.5-Math.random()});for(var c=r?-99999999:99999999,l=0;l<u.length;l++){var p=u[l];if(a.move(p),i=calcBestMove(o-1,a,e,t,n,!r,!1)[0],r?(c<i&&(c=i,v=p),t=Math.max(t,i)):(i<c&&(c=i,v=p),n=Math.min(n,i)),a.undo(),n<=t)break}return[c,v||u[0]]};onmessage=function(o){positionCount=0,game.load(o.data.fen);var a=calcBestMove(o.data.depth,game,o.data.aiColor,-999999,999999,!0,o.data.possibleMoves);postMessage({positionCount:positionCount,bestMove:{val:a[0],mov:a[1]}})};